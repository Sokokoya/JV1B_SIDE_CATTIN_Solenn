<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />

    <title>SUN RIDE</title>

    <script src="//cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
    <style type="text/css"> body { margin: 0; }</style>
    <link rel="icon" href="assets/logo_jeu.ico" />
</head>



<body>
    <script type="text/javascript">


        // -----------------------------------------------------------------------------------------
        // ------------------------------- CONFIGURATION INITIALE ----------------------------------
        // -----------------------------------------------------------------------------------------
        var config = {
            type: Phaser.AUTO,
            width: 1600, height: 1600,
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 300 },
                    debug: true
                }
            },
            scene: {preload: preload, create: create, update: update},

            // active la possibilité de jouer a la manette
            input: {gamepad: true}

            
        };

        new Phaser.Game(config);


        // -----------------------------------------------------------------------------------------
        // ---------------------------------- FONCTION PRELOAD -------------------------------------
        // -----------------------------------------------------------------------------------------
        function preload() {
            this.load.image('backgroundImg', 'assets/background.png');
            this.load.image('tileset', 'assets/tileset.png');
            this.load.tilemapTiledJSON("map", "assets/map.json"); 

            this.load.spritesheet('coeurs', 
                'assets/sprite_coeurs.png',
                { frameWidth: 64, frameHeight: 64 }
            );

            this.load.spritesheet('perso', 'assets/sprite.png', {frameWidth: 32, frameHeight: 64});
            this.load.spritesheet('ennemi', 'assets/sprite_ennemi.png', {frameWidth: 32, frameHeight: 32});
        }



        // -----------------------------------------------------------------------------------------
        // ------------------------ DECLARATION DES VARIABLES ET FONCTIONS--------------------------
        // -----------------------------------------------------------------------------------------

        var platformes;
        var nombreCoeurs = 3;
        //var nbCoeursTexte;


        // ----- Variables et Fonctions permettant d'effectuer un saut mural -----
        var sautMural = true;
        var toucheBloquee = false;

        function bloqueTouche() {
            toucheBloquee = true;
        }

        function timerSautMural() {
            sautMural = true;
        }


        // ----- Fonction utilisee pour reset le jeu lorsque le joueur meurt -----
        function reloadJeu() {
            location.reload();
            nombreCoeurs = 3;
        }

        // ----- Fonction utilisée lorsque le joueur touche un pic -----
        function touchePic() {
            console.log("pics touches => mort immediate");
            
            nombreCoeurs = 0;
            updateCoeurs();
            setTimeout(reloadJeu, 450);
            this.physics.pause();
            this.player.setTint(0xff0000);
        }


        // ----- Fonction utilisée lorsque le joueur touche un ennemi -----
        // #TODO : bug
        function toucheEnnemi(ennemi) {

            // Si le joueur touche l'ennemi passé en parametre par un de ses cotes
            if (this.player.blocked.right || this.player.blocked.left) {
                console.log("ennemi touche => un coeur en moins");
                nombreCoeurs -= 1;
                updateCoeurs();

                // Si le nombre de coeurs du joueur est a zero, celui ci meurt
                if (nombreCoeurs == 0) {
                    console.log("plus de coeurs => mort immediate");
                    setTimeout(reloadJeu, 450);
                    this.physics.pause();
                    this.player.setTint(0xff0000);

                // Sinon le joueur prend seulement ses degats et se teinte en rouge
                } else {
                    setTimeout(this.player.setTint(0xff0000), 200);
                }
               
            // Sinon, si le joueur saute sur le sprite ennemi, il le fait disparaitre
            } else if (this.player.blocked.down) {
                setTimeout(ennemi.setTint(0xff0000), 200);
                ennemi.destroy();
            }            
        }


        // ----- Fonction qui rajoute un coeur au joueur -----
        function ajoutCoeur() {
            nombreCoeurs += 1;

            setTimeout(updateCoeurs, 100);
        }


        // ----- Fonction changeant l'image du sprite coeur en fonction du nb de vie qu'il reste au joueur -----
        function updateCoeurs() {

            if (nombreCoeurs >= 3) {
                nombreCoeurs = 3;
                coeurs.anims.play('coeur3', true);
            } else if (nombreCoeurs == 2) {
                coeurs.anims.play('coeur2', true);
            } else if (nombreCoeurs == 1) {
                coeurs.anims.play('coeur1', true);
            } else {
                coeurs.anims.play('coeur0', true);
            }
        }

        // ----- Fonctions qui doublent la vitesse de deplacement lorsqu'un eclair est touché -----
        function toucheEclair() {
            setTimeout(deplacementDouble, 200);
        }

        function deplacementDouble() {
            if (cursors.left.isDown) {
                this.player.setVelocityX(-320);

            } else if (cursors.right.isDown) {
                this.player.setVelocityX(320);

            } else {
                this.player.setVelocityX(0);
            }

            if (cursors.up.isDown && this.player.body.blocked.down) {
                this.player.setVelocityY(-540);
            }
        }

        // ----- Fonction alterant la gravité permettant au joueur de monter l'echelle -----
        function monteEchelle() {
            setTimeout(this.player.setVelocityY(-3000), 200);
        }



        // -----------------------------------------------------------------------------------------
        // ----------------------------------- FONCTION CREATE -------------------------------------
        // -----------------------------------------------------------------------------------------
        function create() {


            // ----- AFFICHAGE DU JEU -----

            // Ajout de l'image de background
            this.add.image(800, 800, 'backgroundImg');

            // Chargement des calques
            const gameMap = this.add.tilemap("map");

            const gameTileset = gameMap.addTilesetImage(
                "tileset",
                "tileset"
            ); 
            
            const spikesLayer = gameMap.createLayer(
                "pointes",
                gameTileset
            );
            
            const platformLayer = gameMap.createLayer(
                "plateformes",
                gameTileset
            );

            const echelleLayer = gameMap.createLayer(
                "echelle",
                gameTileset
            );

            const coeursLayer = gameMap.createLayer(
                "coeurs",
                gameTileset
            );

            const eclairLayer = gameMap.createLayer(
                "eclairs",
                gameTileset
            );
                
            // #TODO : changer ici pour mettre les images des coeurs en fonction du nb de coeurs restants
            //nbCoeursTexte = this.add.text(16, 16, 'Coeurs : 3', { fontSize: '32px', fill: '#000' });
            coeurs = this.physics.add.sprite(32, 32, 'coeurs');
            coeurs.setCollideWorldBounds(true);
            coeurs.body.setGravity(-1);

            this.physics.add.collider(coeurs, platformLayer);

            this.anims.create({
                key: 'coeur1',
                frames: [ { key: 'coeurs', frame: 0 } ],
                frameRate: 20
            });

            this.anims.create({
                key: 'coeur2',
                frames: [ { key: 'coeurs', frame: 1 } ],
                frameRate: 20
            });

            this.anims.create({
                key: 'coeur3',
                frames: [ { key: 'coeurs', frame: 2 } ],
                frameRate: 20
            });

            this.anims.create({
                key: 'coeur0',
                frames: [ { key: 'coeurs', frame: 3 } ],
                frameRate: 20
            });


            // ----- PROPRIETES DU JEU -----

            // Prise en charge des touches directionelles du clavier
            cursors = this.input.keyboard.createCursorKeys();


            // Ajout des collisions, utilisation de la propriété estSolide
            platformLayer.setCollisionByProperty({estSolide: true}); 
            spikesLayer.setCollisionByProperty({estSolide: true}); 



            // ----- AFFICHAGE ET PROPRIETES DU PERSONNAGE -----

            // Ajout du personnage dans le jeu
            this.player = this.physics.add.sprite(1584, 1024, 'perso');
            this.player.setCollideWorldBounds(true);

            // Ajout des collisions entre le joueur et les plateformes/pointes
            this.physics.add.collider(this.player, platformLayer); 
            this.physics.add.collider(this.player, spikesLayer, touchePic, null, this); 

            // #TODO : probleme ici -> la fonction ajoutCoeur se lance sans cesse + donner un max de coeurs possibles
            this.physics.add.collider(this.player, coeursLayer, ajoutCoeur, null, this);

            // #TODO : essayer avec la fonction overlap et non collider
            this.physics.add.collider(this.player, eclairLayer, toucheEclair, null, this);
            

            // ----- AFFICHAGE ET PROPRIETES DES ENNEMIS -----

            // Ajout du sprite ennemi et ajout des collisions avec les plateformes
            this.ennemi1 = this.physics.add.sprite(592, 1168, 'ennemi');
            this.ennemi1.setCollideWorldBounds(true);
            this.physics.add.collider(this.ennemi1, platformLayer);

            // Ajout du mouvement de l'ennemi grace a un Tween
            tween_mouvement = this.tweens.add({
                targets: [this.ennemi1],
                paused: false,
                ease: "Linear",  // vitesse du mouvement lineaire
                duration: 2000,
                yoyo: true, 
                x: "+=240", 
                delay: 0,
                hold: 1000, 
                repeatDelay: 1000, 
                repeat: -1 // repetition infinie 
            });

            // Ajout des collisions entre le personnage et l'ennemi'
            this.physics.add.collider(this.player, this.ennemi1, toucheEnnemi);


            // ----- SETTINGS DE LA CAMERA -----

            // Redimensions du jeu selon le fichier Tiled
            this.physics.world.setBounds(0, 0, 1600, 1600);
            // #TODO : reussir a gerer la camera sans tout faire bug
            this.cameras.main.setBounds(0, 0, 1600, 1600);

            // Tracking de la caméra sur le joueur
            this.cameras.main.startFollow(this.player); 
            //this.cameras.main.zoom = 2;

        }
        


        // -----------------------------------------------------------------------------------------
        // ----------------------------------- FONCTION UPDATE -------------------------------------
        // -----------------------------------------------------------------------------------------
        function update() {
            // GAMEPAD
            this.input.gamepad.once('connected', function (pad) {
                // 'pad' is a reference to the gamepad that was just connected
            });


            updateCoeurs();
            // ----- DEPLACEMENT ET SAUTS DU SPRITE -----
            // #TODO : RAJOUTER TOUS LES DEPLACEMENTS AU GAMEPAD

            // Deplacement de gauche a droite
            if (cursors.left.isDown) {
                this.player.setVelocityX(-160);
                //player.anims.play('left', true);
            } else if (cursors.right.isDown) {
                this.player.setVelocityX(160);
                //player.anims.play('right', true);
            } else {
                this.player.setVelocityX(0);
            }

            // Saut simple
            // ne fonctionne que si le joueur est sur une plateforme
            if (cursors.up.isDown && this.player.body.blocked.down) {
                this.player.setVelocityY(-270);
            }
            
            // Saut mural de droite a gauche || controller.up && this.player.body.blocked.right
            // Fonctionne si le joueur est a colle a la gauche d'un mur
            if (cursors.up.isDown && this.player.body.blocked.right) {
                if (sautMural == true) {

                    sautMural = false;
                    toucheBloquee = false;

                    setTimeout(bloqueTouche, 200);
                    setTimeout(timerSautMural, 500);

                    this.player.setVelocityY(-270);
                    this.player.setVelocityX(-160);
                }
            }

            // Saut mural de gauche a droite || controller.up && this.player.body.blocked.left
            // Fonctionne si le joueur est a colle a la droite d'un mur
            if (cursors.up.isDown && this.player.body.blocked.left ) {
                if (sautMural == true) {

                    sautMural = false;
                    toucheBloquee = false;

                    setTimeout(bloqueTouche, 200);
                    setTimeout(timerSautMural, 500);
                    

                    this.player.setVelocityY(-270);
                    this.player.setVelocityX(160);
                }
            }


        }
        
    </script>
</body>

</html>