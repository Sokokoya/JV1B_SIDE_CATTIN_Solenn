<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />

    <title>SUN RIDE</title>

    <script src="//cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
    <style type="text/css"> body { margin: 0; }</style>
    <link rel="icon" href="assets/logo_jeu.ico" />
</head>



<body>
    <script type="text/javascript">


        // -----------------------------------------------------------------------------------------
        // ------------------------------- CONFIGURATION INITIALE ----------------------------------
        // -----------------------------------------------------------------------------------------
        var config = {
            type: Phaser.AUTO,
            // 800 , 500
            width: 800, height: 500,
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 300 },
                    debug: true
                }
            },
            scene: {preload: preload, create: create, update: update},

            // active la possibilité de jouer a la manette
            input: {gamepad: true}

            
        };

        new Phaser.Game(config);


        // -----------------------------------------------------------------------------------------
        // ---------------------------------- FONCTION PRELOAD -------------------------------------
        // -----------------------------------------------------------------------------------------
        function preload() {
            this.load.image('backgroundImg', 'assets/background.png');
            this.load.image('tileset', 'assets/tileset.png');
            this.load.tilemapTiledJSON("map", "assets/map.json"); 

            this.load.spritesheet('coeurs', 'assets/sprite_coeurs.png', {frameWidth: 64, frameHeight: 64});

            this.load.spritesheet('perso', 'assets/sprite.png', {frameWidth: 32, frameHeight: 64});
            this.load.spritesheet('ennemi', 'assets/sprite_ennemi.png', {frameWidth: 32, frameHeight: 32});
        }



        // -----------------------------------------------------------------------------------------
        // ----------------------- DECLARATION DES VARIABLES ET FONCTIONS --------------------------
        // -----------------------------------------------------------------------------------------

        var nombreCoeurs = 3;
        var gameOver = false;


        // ----- VARIABLES PERMETTANT L'UTILISATION DE LA MANETTE -----
        var gamepadConnected = false;
        var gamepad;
        var gamepadButton;


        // ----- VARIABLES ET FONCTIONS PERMETTANT D'EFFECTUER UN SAUT MURAL -----
        var sautMural = true;
        var toucheBloquee = false;

        function bloqueTouche() {
            toucheBloquee = true;
        }

        function timerSautMural() {
            sautMural = true;
        }


        // ----- FONCTION UTILISEE LORSQUE LE JOUEUR TOUCHE UN PIC -----
        function touchePic() {
                console.log("pics touches => mort immediate");
                this.collisionPics.active = false;

                setTimeout(() => {
                    location.reload();
                }, 450);

                this.physics.pause();
                this.player.setTint(0xff0000);
        }


        // ----- FONCTION UTILISEE LORSQUE LE JOUEUR TOUCHE UN ENNEMI -----
        // #TODO : corriger bug (ennemi one shot le joueur + ne tue pas l'ennemi)
        function toucheEnnemi() {
               
            // Si l'ennemi a un element au dessus de lui
            if (this.ennemi1.body.blocked.up) {
                setTimeout(ennemi1.setTint(0xff0000), 200);
                ennemi1.destroy();

            // Sinon, c'est que le joueur le touche d'un de ses cotes
            } else {
                console.log("ennemi touche => un coeur en moins");
                nombreCoeurs -= 1;
                updateCoeurs();

                // Si le nombre de coeurs du joueur est a zero, celui ci meurt
                if (nombreCoeurs == 0) {
                    console.log("plus de coeurs => mort immediate");
                    this.collisionEnnemi.active = false;

                    setTimeout(() => {
                        location.reload();
                    }, 450);

                    this.physics.pause();
                    this.player.setTint(0xff0000);
                    gameOver = true;

                // Sinon le joueur prend seulement ses degats et se teinte en rouge
                } else {
                    setTimeout(this.player.setTint(0xff0000), 200);
                }
            }    
        }


        // ----- FONCTION RAJOUTANT UN COEUR AU JOUEUR -----
        function ajoutCoeur() {
            nombreCoeurs += 1;

            setTimeout(updateCoeurs, 100);
        }


        // ----- FONCTION UPDATE DE L'IMAGE DU NB DE COEURS RESTANT -----
        function updateCoeurs() {

            if (nombreCoeurs >= 3) {
                nombreCoeurs = 3;
                coeurs.anims.play('coeur3', true);
            } else if (nombreCoeurs == 2) {
                coeurs.anims.play('coeur2', true);
            } else if (nombreCoeurs == 1) {
                coeurs.anims.play('coeur1', true);
            } else {
                coeurs.anims.play('coeur0', true);
            }
        }

        // ----- FONCTION AUGMENTANT LA VITESSE DE DEPLACEMENT LORSQU'UN ECLAIR EST TOUCHE -----
        function toucheEclair() {
            setTimeout(deplacementDouble, 400);
        }

        function deplacementDouble() {
            if (cursors.left.isDown) {
                this.player.setVelocityX(-640);

            } else if (cursors.right.isDown) {
                this.player.setVelocityX(640);

            } else {
                this.player.setVelocityX(0);
            }

            if (cursors.up.isDown && this.player.body.blocked.down) {
                this.player.setVelocityY(-1080);
            }
        }


        // ----- FONCTION ALTERANT LA GRAVITE PERMETTANT DE MONTER L'ECHELLE -----
        function monteEchelle() {
            setTimeout(this.player.setVelocityY(-3000), 200);
        }



        // -----------------------------------------------------------------------------------------
        // ----------------------------------- FONCTION CREATE -------------------------------------
        // -----------------------------------------------------------------------------------------
        function create() {


            // ----- AFFICHAGE DU JEU -----

            // Ajout de l'image de background
            this.add.image(800, 800, 'backgroundImg');

            // Chargement des calques
            const gameMap = this.add.tilemap("map");

            const gameTileset = gameMap.addTilesetImage(
                "tileset",
                "tileset"
            ); 
            
            const spikesLayer = gameMap.createLayer(
                "pointes",
                gameTileset
            );
            
            const platformLayer = gameMap.createLayer(
                "plateformes",
                gameTileset
            );

            const echelleLayer = gameMap.createLayer(
                "echelle",
                gameTileset
            );

            const coeursLayer = gameMap.createLayer(
                "coeurs",
                gameTileset
            );

            const eclairLayer = gameMap.createLayer(
                "eclairs",
                gameTileset
            );
                

            // ----- AFFICHAGE DE L'INTERFACE UTILISATEUR -----
            


            // ----- AFFICHAGE DU NOMBRE DE COEURS DU JOUEUR -----
            
            coeurs = this.physics.add.sprite(32, 32, 'coeurs').setScrollFactor(0);
            coeurs.body.setAllowGravity(false);

            this.anims.create({
                key: 'coeur1',
                frames: [ { key: 'coeurs', frame: 0 } ],
                frameRate: 20
            });

            this.anims.create({
                key: 'coeur2',
                frames: [ { key: 'coeurs', frame: 1 } ],
                frameRate: 20
            });

            this.anims.create({
                key: 'coeur3',
                frames: [ { key: 'coeurs', frame: 2 } ],
                frameRate: 20
            });

            this.anims.create({
                key: 'coeur0',
                frames: [ { key: 'coeurs', frame: 3 } ],
                frameRate: 20
            });



            // ----- PROPRIETES DU JEU -----

            // Prise en charge des touches directionelles du clavier
            cursors = this.input.keyboard.createCursorKeys();

            // Ajout des collisions, utilisation de la propriété estSolide
            platformLayer.setCollisionByProperty({estSolide: true}); 



            // ----- AFFICHAGE ET PROPRIETES DU PERSONNAGE -----

            // Ajout du personnage dans le jeu
            this.player = this.physics.add.sprite(1584, 1024, 'perso');
            this.player.setCollideWorldBounds(true);
            

            // Ajout des collisions entre le joueur et les plateformes/pointes
            this.physics.add.collider(this.player, platformLayer); 
            this.collisionPics = this.physics.add.collider(this.player, spikesLayer, touchePic, null, this); 

            this.physics.add.collider(this.player, coeursLayer, ajoutCoeur, null, this);
            this.physics.add.collider(this.player, eclairLayer, toucheEclair, null, this);
            


            // ----- AFFICHAGE ET PROPRIETES DES ENNEMIS -----

            // Ajout du sprite ennemi et ajout des collisions avec les plateformes
            this.ennemi1 = this.physics.add.sprite(592, 1168, 'ennemi');
            this.ennemi1.setCollideWorldBounds(true);
            this.physics.add.collider(this.ennemi1, platformLayer);

            // Ajout du mouvement de l'ennemi grace a un Tween
            tween_mouvement = this.tweens.add({
                targets: [this.ennemi1],
                paused: false,
                ease: "Linear",  
                duration: 2000,
                yoyo: true, 
                x: "+=240", 
                delay: 0,
                hold: 1000, 
                repeatDelay: 1000, 
                repeat: -1 
            });

            // Ajout des collisions entre le personnage et l'ennemi'
            this.collisionEnnemi = this.physics.add.collider(this.player, this.ennemi1, toucheEnnemi, null, this);



            // ----- SETTINGS DE LA CAMERA -----

            // Redimensions du jeu selon le fichier Tiled
            this.physics.world.setBounds(0, 0, 1600, 1600);
            this.cameras.main.setBounds(0, 0, 1600, 1600);

            // Tracking de la caméra sur le joueur
            this.cameras.main.startFollow(this.player); 
            //this.cameras.main.zoom = 1.5;

        }
        


        // -----------------------------------------------------------------------------------------
        // ----------------------------------- FONCTION UPDATE -------------------------------------
        // -----------------------------------------------------------------------------------------
        function update() {

            // ----- INTEGRATION DU GAMEPAD -----
            this.input.gamepad.on('connected', () => {
                gamepad = this.input.gamepad.pad1;
                console.log("Controller connected!");
                
                gamepadButton = {
                    'left': gamepad.buttons[14],
                    'right': gamepad.buttons[15],
                    'jump': gamepad.buttons[0],
                    'pause': gamepad.buttons[9]
                };
            });


            updateCoeurs();
            // ----- DEPLACEMENT ET SAUTS DU SPRITE -----

            // Deplacement de gauche a droite
            if (cursors.left.isDown || gamepadButton?.left) {
                this.player.setVelocityX(-160);
                
            } else if (cursors.right.isDown || gamepadButton?.right) {
                this.player.setVelocityX(160);
                
            } else {
                this.player.setVelocityX(0);
            }

            // Saut simple
            // ne fonctionne que si le joueur est sur une plateforme
            if ((cursors.up.isDown || gamepadButton?.jump) && this.player.body.blocked.down) {
                this.player.setVelocityY(-270);
            }
            
            // Saut mural de droite a gauche
            // Fonctionne si le joueur est a colle a la gauche d'un mur
            if ((cursors.up.isDown || gamepadButton?.jump) && this.player.body.blocked.right) {
                if (sautMural == true) {

                    sautMural = false;
                    toucheBloquee = false;

                    setTimeout(bloqueTouche, 200);
                    setTimeout(timerSautMural, 500);

                    this.player.setVelocityY(-270);
                    this.player.setVelocityX(-160);
                }
            }

            // Saut mural de gauche a droite
            // Fonctionne si le joueur est a colle a la droite d'un mur
            if ((cursors.up.isDown || gamepadButton?.jump) && this.player.body.blocked.left ) {
                if (sautMural == true) {

                    sautMural = false;
                    toucheBloquee = false;

                    setTimeout(bloqueTouche, 200);
                    setTimeout(timerSautMural, 500);
                    

                    this.player.setVelocityY(-270);
                    this.player.setVelocityX(160);
                }
            }
        }
        
    </script>
</body>

</html>