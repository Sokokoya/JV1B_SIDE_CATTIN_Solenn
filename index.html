<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />

    <title>SUN RIDE</title>

    <script src="//cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
    <style type="text/css"> body { margin: 0; }</style>
    <link rel="icon" href="assets/logo_jeu.ico" />
</head>



<body>
    <script type="text/javascript">


        // -----------------------------------------------------------------------------------------
        // ------------------------------- CONFIGURATION INITIALE ----------------------------------
        // -----------------------------------------------------------------------------------------
        var config = {
            type: Phaser.AUTO,
            width: 500, height: 400,
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 300 },
                    debug: false
                }
            },
            scene: {preload: preload, create: create, update: update},

            // active la possibilité de jouer a la manette
            input: {gamepad: true}

            
        };

        new Phaser.Game(config);


        // -----------------------------------------------------------------------------------------
        // ---------------------------------- FONCTION PRELOAD -------------------------------------
        // -----------------------------------------------------------------------------------------
        function preload() {
            this.load.image('backgroundImg', 'assets/background.png');
            this.load.image('tileset', 'assets/tileset.png');
            this.load.tilemapTiledJSON("map", "assets/map.json"); 

            this.load.spritesheet('perso', 'assets/sprite.png', {frameWidth: 32, frameHeight: 64});
        }



        // -----------------------------------------------------------------------------------------
        // ------------------------ DECLARATION DES VARIABLES ET FPNCTIONS--------------------------
        // -----------------------------------------------------------------------------------------
        var platformes;

        // Variables permettant d'effectuer un saut mural
        var sautMural = true;
        var toucheBloquee = false;


        function bloqueTouche() {
            toucheBloquee = true;
        }

        function timerSautMural() {
            sautMural = true;
        }



        // -----------------------------------------------------------------------------------------
        // ----------------------------------- FONCTION CREATE -------------------------------------
        // -----------------------------------------------------------------------------------------
        function create() {


            // ----- AFFICHAGE DU JEU -----

            // Ajout de l'image de background
            this.add.image(800, 800, 'backgroundImg');

            // Chargement des calques
            const gameMap = this.add.tilemap("map");

            const gameTileset = gameMap.addTilesetImage(
                "tileset",
                "tileset"
            ); 
            
            const spikesLayer = gameMap.createLayer(
                "pointes",
                gameTileset
            );
            
            const platformLayer = gameMap.createLayer(
                "plateformes",
                gameTileset
            );

            const objetLayer = gameMap.createLayer(
                "objets",
                gameTileset
            )
                

            // ----- PROPRIETES DU JEU -----

            // Prise en charge des touches directionelles du clavier
            cursors = this.input.keyboard.createCursorKeys();


            // Ajout des collisions, utilisation de la propriété estSolide
            platformLayer.setCollisionByProperty({estSolide: true}); 
            spikesLayer.setCollisionByProperty({estSolide: true}); 



            // ----- AFFICHAGE ET PROPRIETES DU PERSONNAGE -----

            // Ajout du personnage dans le jeu
            this.player = this.physics.add.sprite(1584, 1024, 'perso');
            this.player.setCollideWorldBounds(true);

            // Ajout des collisions entre le joueur et les plateformes/pointes
            this.physics.add.collider(this.player, platformLayer); 
            this.physics.add.collider(this.player, spikesLayer); 

            // Redimensions du jeu selon le fichier Tiled
            this.physics.world.setBounds(0, 0, 1600, 1600);
            this.cameras.main.setBounds(0, 0, 1600, 1600);

            // Tracking de la caméra sur le joueur
            this.cameras.main.startFollow(this.player); 
            this.cameras.main.zoom = 2;

            



            /*
              A AJOUTER
              - controles au clavier ou a la manette
              - indicateurs de vie + invulnerabilité
              - Ennemis : fait perdre de la vie, comportement déterminé, possibilité de les faire disparaitre
              /- Deplacement en rebondissant sur les parois rocheuses
              - altéraion du deplacement : gravité alterée
              - obstacles causant la fin du jeu (mort du personnage)
              - Power-up debloquant une capacité (eclairs -> charges electriques a depenser)
              /- scrolling vertical et horizontal, parallaxe
            */
        }
        


        // -----------------------------------------------------------------------------------------
        // ----------------------------------- FONCTION UPDATE -------------------------------------
        // -----------------------------------------------------------------------------------------
        function update() {
            /* GAMEPAD
            this.input.gamepad.once('connected', function (pad) {
                // 'pad' is a reference to the gamepad that was just connected
            });*/


            // ----- DEPLACEMENT ET SAUTS DU SPRITE -----
            // Deplacement de gauche a droite
            if (cursors.left.isDown) {
                this.player.setVelocityX(-160);
                //player.anims.play('left', true);
            } else if (cursors.right.isDown) {
                this.player.setVelocityX(160);
                //player.anims.play('right', true);
            } else {
                this.player.setVelocityX(0);
            }

            // Saut simple
            // ne fonctionne que si le joueur est sur une plateforme
            if (cursors.up.isDown && this.player.body.blocked.down) {
                this.player.setVelocityY(-270);
            }
            

            // Saut mural de droite a gauche || controller.up && this.player.body.blocked.right
            // Fonctionne si le joueur est a colle a la gauche d'un mur
            if (cursors.up.isDown && this.player.body.blocked.right) {
                if (sautMural == true) {

                    sautMural = false;
                    toucheBloquee = false;

                    setTimeout(bloqueTouche(), 200);
                    setTimeout(timerSautMural(), 500);

                    this.player.setVelocityY(-270);
                    this.player.setVelocityX(-160);
                }
            }

            // Saut mural de gauche a droite || controller.up && this.player.body.blocked.left
            // Fonctionne si le joueur est a colle a la droite d'un mur
            if (cursors.up.isDown && this.player.body.blocked.left ) {
                if (sautMural == true) {

                    sautMural = false;
                    toucheBloquee = false;

                    setTimeout(bloqueTouche(), 200);
                    setTimeout(timerSautMural(), 500);
                    

                    this.player.setVelocityY(-270);
                    this.player.setVelocityX(160);
                }
            }
        }
        
    </script>
</body>

</html>